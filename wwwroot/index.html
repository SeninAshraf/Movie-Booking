<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movie Booking Demo</title>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 20px; }
        .screen { background: #333; color: white; padding: 10px; margin-bottom: 30px; border-radius: 5px;}
        .seats-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; max-width: 400px; margin: 0 auto; }
        .seat {
            width: 50px; height: 50px; background: #ddd; border-radius: 8px; cursor: pointer;
            display: flex; align-items: center; justify-content: center; font-weight: bold;
            transition: 0.2s; position: relative;
        }
        .seat.available { background: #8bc34a; color: white; }
        .seat.held { background: #ffc107; color: black; cursor: not-allowed; }
        .seat.booked { background: #f44336; color: white; cursor: not-allowed; }
        .seat.selected { border: 4px solid #000; box-shadow: 0 0 10px rgba(0,0,0,0.5); transform: scale(1.1); }
        
        .controls { margin-top: 30px; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; }
        .user-info { margin-bottom: 20px; }
        #log { margin-top: 20px; color: #666; font-size: 0.9em; height: 100px; overflow-y: auto; border: 1px solid #eee; padding: 10px;}
    </style>
</head>
<body>

    <h1>üé¨ Cinema Booking Demo</h1>
    <div class="user-info">
        Acting as User: <strong><span id="username">Guest</span></strong> 
        <button onclick="changeUser()">Change User</button>
    </div>

    <div class="screen">SCREEN</div>

    <div id="seats" class="seats-container">Loading...</div>

    <div class="controls">
        <button onclick="holdSelected()">1. Hold Selected</button>
        <button onclick="confirmBooking()">2. Confirm Booking</button>
    </div>

    <div id="log"></div>

    <script>
        let currentShowId = null;
        // Generate random user
        let currentUser = "User_" + Math.floor(Math.random() * 1000);
        document.getElementById("username").textContent = currentUser;

        let selectedSeatIds = [];
        let seatsData = [];

        function log(msg) {
            const el = document.getElementById("log");
            el.innerHTML = "<div>" + new Date().toLocaleTimeString() + ": " + msg + "</div>" + el.innerHTML;
        }

        function changeUser() {
            currentUser = prompt("Enter username:", currentUser) || currentUser;
            document.getElementById("username").textContent = currentUser;
            selectedSeatIds = []; // Clear selection on user switch
            renderSeats();
        }

        async function init() {
            // Find Show
            try {
                const res = await fetch('/api/shows');
                const shows = await res.json();
                if (shows.length === 0) {
                    document.getElementById("seats").innerHTML = "No shows found. Run seeds?";
                    return;
                }
                currentShowId = shows[0].id; // Just pick first
                log("Loaded Show: " + shows[0].movieTitle);
                startPolling();
            } catch (e) {
                log("Error loading shows: " + e);
            }
        }

        async function refreshSeats() {
            if (!currentShowId) return;
            try {
                const res = await fetch(`/api/shows/${currentShowId}/availability`);
                seatsData = await res.json();
                renderSeats();
            } catch (e) {
                console.error(e);
            }
        }

        function renderSeats() {
            const container = document.getElementById("seats");
            container.innerHTML = "";

            // Sort by number
            seatsData.sort((a, b) => a.number - b.number);

            seatsData.forEach(seat => {
                const div = document.createElement("div");
                div.className = "seat";
                
                // Status mapping from Enum: 0=Avail, 1=Held, 2=Booked
                if (seat.status === 2) {
                    div.classList.add("booked");
                    div.title = "Booked";
                } else if (seat.status === 1) {
                    div.classList.add("held");
                    
                    // Is it held by ME?
                    if (seat.userId === currentUser) {
                         div.style.border = "2px dashed #000";
                         div.title = "Held by YOU";
                    } else {
                         div.title = "Held by " + seat.userId;
                    }
                } else {
                    div.classList.add("available");
                    div.onclick = () => toggleSelect(seat.id);
                }

                if (selectedSeatIds.includes(seat.id)) {
                    div.classList.add("selected");
                }

                div.innerText = seat.number;
                container.appendChild(div);
            });
        }

        function toggleSelect(id) {
            if (selectedSeatIds.includes(id)) {
                selectedSeatIds = selectedSeatIds.filter(x => x !== id);
            } else {
                selectedSeatIds.push(id);
            }
            renderSeats();
        }

        async function holdSelected() {
            if (selectedSeatIds.length === 0) return alert("Select seats first!");
            
            log("Attempting to HOLD...");
            try {
                const res = await fetch(`/api/bookings/${currentShowId}/hold`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ seatIds: selectedSeatIds, userId: currentUser })
                });

                if (!res.ok) {
                    const err = await res.json();
                    log("‚ùå Hold Failed: " + err.message);
                    alert("Failed: " + err.message);
                } else {
                    const data = await res.json();
                    log("‚úÖ " + data.message);
                    selectedSeatIds = []; // Clear selection logic, now they are held
                    refreshSeats();
                }
            } catch (e) {
                log("Error: " + e);
            }
        }

        async function confirmBooking() {
            log("Attempting to CONFIRM...");
             try {
                const res = await fetch(`/api/bookings/${currentShowId}/confirm`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: currentUser })
                });

                if (!res.ok) {
                    const err = await res.json();
                     log("‚ùå Confirm Failed: " + err.message);
                    alert("Failed: " + err.message);
                } else {
                    log("üéâ Booking Confirmed!");
                    refreshSeats();
                }
            } catch (e) {
                log("Error: " + e);
            }
        }

        function startPolling() {
            refreshSeats();
            setInterval(refreshSeats, 1000); // 1 sec poll for concurrency demo
        }

        init();
    </script>
</body>
</html>
